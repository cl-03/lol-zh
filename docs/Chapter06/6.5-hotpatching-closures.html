

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>6.5 热修复闭包 &mdash; Let Over Lambda 中文文档  文档</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="6.6 字词法作用域" href="6.6-sub-lexical-scope.html" />
    <link rel="prev" title="6.4 间接链" href="6.4-indirection-chains.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Let Over Lambda 中文文档
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Chapter01/index.html">第一章：概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter02/index.html">第二章：闭包</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter03/index.html">第三章：宏基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter04/index.html">第四章：Read 宏</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter05/index.html">第五章：Programs that program</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">第六章：回指(Anaphoric) 宏</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="6.1-more-phors.html">6.1 More Phors?</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.2-sharp-backquote.html">6.2 Sharp-Backquote：#`</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.3-alet-and-finite-state-machines.html">6.3 <code class="docutils literal notranslate"><span class="pre">alet</span></code> 和有限状态机</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.4-indirection-chains.html">6.4 间接链</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6.5 热修复闭包</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.6-sub-lexical-scope.html">6.6 字词法作用域</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.7-pandoric-macros.html">6.7 潘多拉宏</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter07/index.html">第七章：宏的效率</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter08/index.html">第八章：Lisp 与 Forth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/index.html">附录</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Let Over Lambda 中文文档</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">第六章：回指(Anaphoric) 宏</a> &raquo;</li>
        
      <li>6.5 热修复闭包</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/Chapter06/6.5-hotpatching-closures.md.txt" rel="nofollow"> 查看页面源码</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="tex2jax_ignore mathjax_ignore section" id="id1">
<h1>6.5 热修复闭包<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<hr class="docutils" />
<p>Author: Doug Hoyte &lt;<a class="reference external" href="mailto:doug&#37;&#52;&#48;hoytech&#46;com">doug<span>&#64;</span>hoytech<span>&#46;</span>com</a>&gt;</p>
<p>Translator: Yuqi Liu &lt;<a class="reference external" href="mailto:yuqi&#46;lyle&#37;&#52;&#48;outlook&#46;com">yuqi<span>&#46;</span>lyle<span>&#64;</span>outlook<span>&#46;</span>com</a>&gt;</p>
<hr class="docutils" />
<p>本节的目的有三个。首先，介绍 <code class="docutils literal notranslate"><span class="pre">alet</span></code> 中 <code class="docutils literal notranslate"><span class="pre">this</span></code> 回指的另一个有趣的用法。其次，讨论了
<em>let over dlambda</em> 。最后，介绍了一种很有用的宏技术，称为回指闭合（ <em>anaphor closing</em> ）。
要详细说明回指闭合，将不用 <code class="docutils literal notranslate"><span class="pre">alet</span></code> 宏，而是使用一个由内而外的展开。<code class="docutils literal notranslate"><span class="pre">alet-hotpatch%</span></code>
是 <code class="docutils literal notranslate"><span class="pre">alet</span></code> 的拓展，有个一个特殊的 lambda 结构。该 <code class="docutils literal notranslate"><span class="pre">lambda</span></code> 结构检查第一个参数是否为关
键字符号 <code class="docutils literal notranslate"><span class="pre">:hotpatch</span></code>，如果是，则用另一个参数替换间接闭包。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(defmacro alet-hotpatch% (letargs &amp;rest body)
  `(let ((this) ,@letargs)
      (setq this ,@(last body))
      ,@(butlast body)
      (lambda (&amp;rest args)
        (if (eq (car args) &#39;:hotpatch)
          (setq this (cadr args))
          (apply this args)))))
</pre></div>
</div>
<p>在运行时更改另一个转发闭包中使用的闭包称为热补丁（ <em>hotpatching</em> ）。例如，这里我们创建
了一个热补丁闭包，并将其存储在 <code class="docutils literal notranslate"><span class="pre">hotpatch-test</span></code> 的 <code class="docutils literal notranslate"><span class="pre">symbol-function</span></code> 单元格中，以便
之后使用：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="p">(</span><span class="n">setf</span> <span class="p">(</span><span class="n">symbol</span><span class="o">-</span><span class="n">function</span> <span class="s1">&#39;hotpatch-test)</span>
    <span class="p">(</span><span class="n">alet</span><span class="o">-</span><span class="n">hotpatch</span><span class="o">%</span> <span class="p">((</span><span class="n">acc</span> <span class="mi">0</span><span class="p">))</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="p">(</span><span class="n">incf</span> <span class="n">acc</span> <span class="n">n</span><span class="p">))))</span>

<span class="c1">#&lt;Interpreted Function&gt;</span>
</pre></div>
</div>
<p>现在可以这样使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="p">(</span><span class="n">hotpatch</span><span class="o">-</span><span class="n">test</span> <span class="mi">3</span><span class="p">)</span>

<span class="mi">3</span>
<span class="o">*</span> <span class="p">(</span><span class="n">hotpatch</span><span class="o">-</span><span class="n">test</span> <span class="mi">4</span><span class="p">)</span>

<span class="mi">7</span>
</pre></div>
</div>
<p>可以用 <code class="docutils literal notranslate"><span class="pre">:hotpatch</span></code> 和替换函数或闭包来替换 lambda 结构及其相关的环境:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="p">(</span><span class="n">hotpatch</span><span class="o">-</span><span class="n">test</span>
    <span class="p">:</span><span class="n">hotpatch</span>
    <span class="p">(</span><span class="n">let</span> <span class="p">((</span><span class="n">acc</span> <span class="mi">0</span><span class="p">))</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="p">(</span><span class="n">incf</span> <span class="n">acc</span> <span class="p">(</span><span class="o">*</span> <span class="mi">2</span> <span class="n">n</span><span class="p">)))))</span>

<span class="c1">#&lt;Interpreted Function&gt;</span>
</pre></div>
</div>
<p>现在闭包有了新的、热补丁的行为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="p">(</span><span class="n">hotpatch</span><span class="o">-</span><span class="n">test</span> <span class="mi">2</span><span class="p">)</span>

<span class="mi">4</span>
<span class="o">*</span> <span class="p">(</span><span class="n">hotpatch</span><span class="o">-</span><span class="n">test</span> <span class="mi">5</span><span class="p">)</span>

<span class="mi">14</span>
</pre></div>
</div>
<p>注意计数器的值是怎么置为 0 的，因为我们还用计数器的累加器 <code class="docutils literal notranslate"><span class="pre">acc</span></code> 的新值热补丁了闭包的环境。
之前见过这种关键字符号的运行时解构吗？没错，实际上在 <a class="reference internal" href="../Chapter05/5.7-dlambda.html"><span class="doc std std-doc">5.7 Dlambda</span></a>中编写了个宏来完成这个
操作。<code class="docutils literal notranslate"><span class="pre">alet-hotpatch</span></code> 是 <code class="docutils literal notranslate"><span class="pre">alet-hotpatch%</span></code> 的 <code class="docutils literal notranslate"><span class="pre">dlambda</span></code> 版本。有时甚至在没有意识到的
情况下，在新的宏定义中会用到之前定义的宏，这就是宏组合（ <em>macro combination</em> ）。使用精心
设计的宏可以完全理解扩展，尽管在许多方面可能违背词汇透明性，但不会出现组合问题，因为
所有组件都能有意义地组合在一起。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(defmacro! alet-hotpatch (letargs &amp;rest body)
  `(let ((,g!this) ,@letargs)
    (setq ,g!this ,@(last body))
    ,@(butlast body)
    (dlambda
        (:hotpatch (closure)
          (setq ,g!this closure))
        (t (&amp;rest args)
          (apply ,g!this args)))))
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">alet-hotpatch</span></code> 创建了个可热补的闭包，但在概念上有一个小缺陷。因为使用 <code class="docutils literal notranslate"><span class="pre">alet-hotpatch</span></code>
的唯一真正原因是创建这种热补丁闭包，但可能忘了，它还将 <code class="docutils literal notranslate"><span class="pre">this</span></code> 回指引入到所提供的作用域中。
当忘了创建的的回指时，就有未知变量捕获问题的风险。为了避免这些问题，可以使用一种回指闭合
的技术。当要结束一个回指时，我们不需要改变回指宏的功能，只是限制他们组合的方式。</p>
<p>因为已经把 <code class="docutils literal notranslate"><span class="pre">alet</span></code> 展开从内到外看了一遍，我们可以在 <code class="docutils literal notranslate"><span class="pre">alet-hotpatch</span></code> 的定义中看到 <code class="docutils literal notranslate"><span class="pre">this</span></code> 回指
的创建。同时也因为 <code class="docutils literal notranslate"><span class="pre">alet-hotpatch</span></code> 中用了 <code class="docutils literal notranslate"><span class="pre">this</span></code> 回指实现 <code class="docutils literal notranslate"><span class="pre">hotpatch</span></code> 代码，所以就可以关闭
回指，这样 <code class="docutils literal notranslate"><span class="pre">this</span></code> 变量就不再被宏捕获了。通常该如何避免引入预期之外的绑定？当然，可以用
gensyms 来命名绑定。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(defmacro! let-hotpatch (letargs &amp;rest body)
  `(let ((,g!this) ,@letargs)
    (setq ,g!this ,@(last body))
    ,@(butlast body)
    (dlambda
      (:hotpatch (closure)
        (setq ,g!this closure))
      (t (&amp;rest args)
        (apply ,g!this args)))))
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">let-hotpatch</span></code> 是将 <code class="docutils literal notranslate"><span class="pre">this</span></code> 回指闭合为一个更包含的版本的示例 —— 一个在只需要进行热补时，更
安全的版本。删掉了名字前面的 <code class="docutils literal notranslate"><span class="pre">a</span></code>，表示这个新宏不再在代码中引入回指。当然，如果出于某种原因
而不是因为热补而想引用 <code class="docutils literal notranslate"><span class="pre">this</span></code>，就应该保留这个回指。</p>
<p>当写了足够多类似的宏后，这种开启和关闭回指的技巧就变成了第二天性。就像在编写宏时，在插入
自由变量时不会想到该如何捕获它们，直到写的词法内容会展开，有时，在开发回指组合和自由变量
插入宏试验时，会放任回指不管。一旦找到了最适用的组合，就可以将宏合并在一起，用 gensyms
替换开发过程中使用的所有回指。像 <code class="docutils literal notranslate"><span class="pre">let-hotpatch</span></code> 一样，该技术可以用 <code class="docutils literal notranslate"><span class="pre">defmacro!</span></code> 将回指的
作用域从宏展开移到宏定义。我们没有从词法上引入回指，而是引入了另一种类型的回指 —— 这种
回指并不是在展开的整个词法作用域内起生效，而只在另一个有限的范围内生效。下节将进一步讲解
这个有效范围。</p>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="6.6-sub-lexical-scope.html" class="btn btn-neutral float-right" title="6.6 字词法作用域" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="6.4-indirection-chains.html" class="btn btn-neutral float-left" title="6.4 间接链" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2021-2022, Yuqi Liu, Xuting Yang.

    </p>
  </div>
    
    
    
    利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    
    由 <a href="https://readthedocs.org">Read the Docs</a>开发. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>