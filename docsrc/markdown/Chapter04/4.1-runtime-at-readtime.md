# 4.1 运行时与读取时

---

Author: Doug Hoyte <[doug@hoytech.com](mailto:doug@hoytech.com)>

Translator: Yuqi Liu <[yuqi.lyle@outlook.com](mailto:yuqi.lyle@outlook.com)>

---

> Syntactic sugar causes cancer of the semicolon. --Alan Perlis

lisp 不仅能直接访问已解析为 cons 单元结构的代码，而且还能访问构成程序的字符，甚至能在字符串到达该阶段（构成程序）之前。 尽管常规宏以树的形式作用于程序，但一种称为*读取宏*的特殊类型的宏可以操作构成程序的原始字符。

在 lisp 中，当要定义一个非 lisp 语法时，使用 lisp 读取器（reader）是没有意义的——那只是为了读取 lisp。 读取宏是用来在 lisp 读取器上手之前处理非 lisp 语法的方法。 lisp 读取器比其他语言更强大的原因是 lisp 有控制其各个方面行为的钩子。 特别是，lisp 允许扩展读取器，以便非 lisp 对象实际上作为 lisp 对象读入。 就像在 lisp 之上构建应用程序并使用宏和函数对其进行扩展一样，lisp 应用程序也可以且经常会渗入这个可扩展性维度。 发生这种情况时，可以使用 lisp 读取器读取任何基于字符的语法，这意味着已将其转换为 lisp 语法了。

虽然常规宏完成的代码转换仅用于将 lisp 代码转换为新的 lisp 代码，但可以创建读取宏将非 lisp 代码转换为 lisp 代码。 与常规宏一样，读取宏是通过下面的函数实现的，因此可以使用 lisp 环境的全部功能。 与提高生产力的宏一样，因为它们为程序员创建了更简洁的领域特定语言，读取宏通过将表达式缩写到甚至不再是 lisp 表达式的程度来提高生产力。 或者说这是真的吗？

如果解析这些非 lisp 领域特定语言就是编写一个简短的读取宏，那么这些非 lisp 语言可能真的是 lisp，只是巧妙地伪装。 如果 lisp 读取器可以直接读取 XML [XML-AS-READ-MACRO]，那么从某种扭曲的意义上说，也许 XML 实际上是 lisp。 类似地，读取宏可以将正则表达式和 SQL 查询直接读入 lisp，所以也许这些语言真的也是 lisp。 代码和数据、lisp 和非 lisp 之间这种模糊区别是许多有趣的哲学问题的根源，这些问题从一开始就让 lisp 程序员感到困惑。

COMMON LISP 内置的读取宏是 **#**。 读取时执行宏。 这个读取宏将对象嵌入到读取的无法序列化但可以使用一些 lisp 代码创建的结构中。 一个有趣的例子是让结构在每次被读取时变成不同的值：
```
* '(football-game
     (game-started-at
       #.(get-internal-real-time))
     (coin-flip
       #.(if (zerop (random 2)) 'heads 'tails)))

(FOOTBALL-GAME
  (GAME-STARTED-AT 187)
  (COIN-FLIP HEADS))
```
即使是同一个表达式，这种结构每次读入的内容都不同：
```
* '(football-game
     (game-started-at
       #.(get-internal-real-time))
     (coin-flip
       #.(if (zerop (random 2)) 'heads 'tails)))

(FOOTBALL-GAME
  (GAME-STARTED-AT 309)
  (COIN-FLIP TAILS))
```
注意 **#** 包围的两个结构。 在读取时执行，而不是在执行时执行。 完整的结构在它们执行之后形成，并且可以通过重新执行读入的最后一个结构并将其与之前的结果进行比较，使用 __*__ 和 **+** 方便变量来看到前后等价（由 **equal** 定义）的 *REPL*[1](https://letoverlambda.com/index.cl/guest/chap4.html#):
```
* (equal * (eval +))

T
```
注意，因为这些结构实际上是在读取时执行的，所以这与使用反引号不同，这将在下一节中更仔细地研究。 我们可以执行类似反引号的结构：
```
* `(football-game
     (game-started-at
       ,(get-internal-real-time))
     (coin-flip
       ,(if (zerop (random 2)) 'heads 'tails)))

(FOOTBALL-GAME
  (GAME-STARTED-AT 791)
  (COIN-FLIP HEADS))
```
但是重新执行这段代码时，会得到到不同的结果，因为反引号作为执行代码的读入：
```
* (equal * (eval +))

NIL ; unless you're really fast and lucky
```
