

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>4.3 Reading Strings &mdash; Let Over Lambda 中文文档  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.4 CL-PPCRE" href="4.4-cl-ppcre.html" />
    <link rel="prev" title="4.2 反引用" href="4.2-backquote.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Let Over Lambda 中文文档
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Chapter01/index.html">第一章：概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter02/index.html">第二章：闭包</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter03/index.html">第三章：宏基础</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">第四章：Read 宏</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="4.1-runtime-at-readtime.html">4.1 运行时与读取时</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.2-backquote.html">4.2 反引用</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.3 Reading Strings</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.4-cl-ppcre.html">4.4 CL-PPCRE</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.5-cyclic-expressions.html">4.5 Cyclic Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.6-reader-security.html">4.6 Reader Security</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter05/index.html">第五章：Programs that program</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter06/index.html">第六章：回指(Anaphoric) 宏</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter07/index.html">第七章：宏的效率</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Chapter08/index.html">第八章：Lisp 与 Forth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/index.html">附录</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Let Over Lambda 中文文档</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">第四章：Read 宏</a> &raquo;</li>
        
      <li>4.3 Reading Strings</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/Chapter04/4.3-reading-strings.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="tex2jax_ignore mathjax_ignore section" id="reading-strings">
<h1>4.3 Reading Strings<a class="headerlink" href="#reading-strings" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<p>Author: Doug Hoyte &lt;<a class="reference external" href="mailto:doug&#37;&#52;&#48;hoytech&#46;com">doug<span>&#64;</span>hoytech<span>&#46;</span>com</a>&gt;</p>
<p>Translator: Yuqi Liu &lt;<a class="reference external" href="mailto:yuqi&#46;lyle&#37;&#52;&#48;outlook&#46;com">yuqi<span>&#46;</span>lyle<span>&#64;</span>outlook<span>&#46;</span>com</a>&gt;</p>
<hr class="docutils" />
<p>In lisp, strings are delimited by the double-quote (“) character. Although strings can contain any character in the character set of your lisp implementation, you can’t directly insert certain characters into the string. If you want to insert the ” character or the \ character, you will need to prefix them with \ characters. This is called <em>escaping</em> the characters. For example, here is how to enter a string containing ” and \ characters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="s2">&quot;Contains </span><span class="se">\&quot;</span><span class="s2"> and </span><span class="se">\\</span><span class="s2">.&quot;</span>

<span class="s2">&quot;Contains </span><span class="se">\&quot;</span><span class="s2"> and </span><span class="se">\\</span><span class="s2">.&quot;</span>
</pre></div>
</div>
<p>This obviously works, but sometimes typing these \ characters becomes tedious and error prone. This is lisp, of course, and if we don’t like something we are free, even encouraged, to change it. In this spirit, this book presents a read macro called #”, or sharp-double-quote. This read macro is for creating strings containing ” and \ characters without invoking escapes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">defun</span> <span class="o">|</span><span class="c1">#&quot;-reader| (stream sub-char numarg)</span>
  <span class="p">(</span><span class="n">declare</span> <span class="p">(</span><span class="n">ignore</span> <span class="n">sub</span><span class="o">-</span><span class="n">char</span> <span class="n">numarg</span><span class="p">))</span>
  <span class="p">(</span><span class="n">let</span> <span class="p">(</span><span class="n">chars</span><span class="p">)</span>
    <span class="p">(</span><span class="n">do</span> <span class="p">((</span><span class="n">prev</span> <span class="p">(</span><span class="n">read</span><span class="o">-</span><span class="n">char</span> <span class="n">stream</span><span class="p">)</span> <span class="n">curr</span><span class="p">)</span>
         <span class="p">(</span><span class="n">curr</span> <span class="p">(</span><span class="n">read</span><span class="o">-</span><span class="n">char</span> <span class="n">stream</span><span class="p">)</span> <span class="p">(</span><span class="n">read</span><span class="o">-</span><span class="n">char</span> <span class="n">stream</span><span class="p">)))</span>
        <span class="p">((</span><span class="ow">and</span> <span class="p">(</span><span class="n">char</span><span class="o">=</span> <span class="n">prev</span> <span class="c1">#\&quot;) (char= curr #\#)))</span>
      <span class="p">(</span><span class="n">push</span> <span class="n">prev</span> <span class="n">chars</span><span class="p">))</span>
    <span class="p">(</span><span class="n">coerce</span> <span class="p">(</span><span class="n">nreverse</span> <span class="n">chars</span><span class="p">)</span> <span class="s1">&#39;string)))</span>

<span class="p">(</span><span class="nb">set</span><span class="o">-</span><span class="n">dispatch</span><span class="o">-</span><span class="n">macro</span><span class="o">-</span><span class="n">character</span>
  <span class="c1">#\# #\&quot; #&#39;|#&quot;-reader|)</span>
</pre></div>
</div>
<p>Sharp-double-quote<a class="reference external" href="https://letoverlambda.com/index.cl/guest/chap4.html">5</a> will start reading the string immediately after its invocation characters: # and “. It will continue to read, character by character, until it encounters the two characters ” and #, in sequence. When it finds this terminating sequence, it returns the string represented by all the characters between the #” and “#. The sharp-double-quote read macro used to be used for bit-strings, but COMMON LISP freed up this useful macro character for us by moving bit-strings to the #* read macro[EARLY-CL-VOTES].</p>
<p>Here is an example evaluation of our new sharp-double-quote:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="c1">#&quot;Contains &quot; and \.&quot;#</span>

<span class="s2">&quot;Contains </span><span class="se">\&quot;</span><span class="s2"> and </span><span class="se">\\</span><span class="s2">.&quot;</span>
</pre></div>
</div>
<p>Notice that when the REPL prints the string, it still uses the ” character as a delimiter, so the ” and \ characters are still escaped in the printed representation of the string. These strings are simply read in as if you escaped the characters manually.</p>
<p>But sometimes #” isn’t good enough. For instance, in this U-language paragraph you are reading right now, I have included the following sequence of characters: “#. Because of this, this paragraph couldn’t have been delimited with #” and “#. And because I hate escaping things, take my word that it wasn’t delimited with regular double quotes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">defun</span> <span class="o">|</span><span class="c1">#&gt;-reader| (stream sub-char numarg)</span>
  <span class="p">(</span><span class="n">declare</span> <span class="p">(</span><span class="n">ignore</span> <span class="n">sub</span><span class="o">-</span><span class="n">char</span> <span class="n">numarg</span><span class="p">))</span>
  <span class="p">(</span><span class="n">let</span> <span class="p">(</span><span class="n">chars</span><span class="p">)</span>
    <span class="p">(</span><span class="n">do</span> <span class="p">((</span><span class="n">curr</span> <span class="p">(</span><span class="n">read</span><span class="o">-</span><span class="n">char</span> <span class="n">stream</span><span class="p">)</span>
               <span class="p">(</span><span class="n">read</span><span class="o">-</span><span class="n">char</span> <span class="n">stream</span><span class="p">)))</span>
        <span class="p">((</span><span class="n">char</span><span class="o">=</span> <span class="c1">#\newline curr))</span>
      <span class="p">(</span><span class="n">push</span> <span class="n">curr</span> <span class="n">chars</span><span class="p">))</span>
    <span class="p">(</span><span class="n">let</span><span class="o">*</span> <span class="p">((</span><span class="n">pattern</span> <span class="p">(</span><span class="n">nreverse</span> <span class="n">chars</span><span class="p">))</span>
           <span class="p">(</span><span class="n">pointer</span> <span class="n">pattern</span><span class="p">)</span>
           <span class="p">(</span><span class="n">output</span><span class="p">))</span>
      <span class="p">(</span><span class="n">do</span> <span class="p">((</span><span class="n">curr</span> <span class="p">(</span><span class="n">read</span><span class="o">-</span><span class="n">char</span> <span class="n">stream</span><span class="p">)</span>
                 <span class="p">(</span><span class="n">read</span><span class="o">-</span><span class="n">char</span> <span class="n">stream</span><span class="p">)))</span>
          <span class="p">((</span><span class="n">null</span> <span class="n">pointer</span><span class="p">))</span>
        <span class="p">(</span><span class="n">push</span> <span class="n">curr</span> <span class="n">output</span><span class="p">)</span>
        <span class="p">(</span><span class="n">setf</span> <span class="n">pointer</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">char</span><span class="o">=</span> <span class="p">(</span><span class="n">car</span> <span class="n">pointer</span><span class="p">)</span> <span class="n">curr</span><span class="p">)</span>
                <span class="p">(</span><span class="n">cdr</span> <span class="n">pointer</span><span class="p">)</span>
                <span class="n">pattern</span><span class="p">))</span>
        <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">null</span> <span class="n">pointer</span><span class="p">)</span>
          <span class="p">(</span><span class="k">return</span><span class="p">)))</span>
      <span class="p">(</span><span class="n">coerce</span>
        <span class="p">(</span><span class="n">nreverse</span>
          <span class="p">(</span><span class="n">nthcdr</span> <span class="p">(</span><span class="n">length</span> <span class="n">pattern</span><span class="p">)</span> <span class="n">output</span><span class="p">))</span>
        <span class="s1">&#39;string))))</span>

<span class="p">(</span><span class="nb">set</span><span class="o">-</span><span class="n">dispatch</span><span class="o">-</span><span class="n">macro</span><span class="o">-</span><span class="n">character</span>
  <span class="c1">#\# #\&gt; #&#39;|#&gt;-reader|)</span>
</pre></div>
</div>
<p>We need a read macro that allows us to customise the delimiter for each specific context where we use it. As is often the case, we need to look no further than Larry Wall’s Perl language for inspiration on the design of programming shortcuts. Perl is a beautiful, wonderfully designed language and possesses many great ideas that are ripe for <em>pilfering</em> by lisp. Lisp is, in some sense, a big blob, a snowball perhaps, that rolls around assimilating ideas from other programming languages, making them its own<a class="reference external" href="https://letoverlambda.com/index.cl/guest/chap4.html">6</a>.</p>
<p>The <strong>#&gt;</strong> read macro is directly inspired by Perl’s <strong>&lt;&lt;</strong> operator. This operator allows Perl programmers to specify a string of text to act as the end delimiter for a quoted string. <strong>#&gt;</strong> reads characters until it finds a newline character, then reads characters, one-by-one, until it encounters a sequence of characters identical to the characters it found immediately after <strong>#&gt;</strong> and before the newline.
​
例如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="c1">#&gt;END</span>
<span class="n">I</span> <span class="n">can</span> <span class="n">put</span> <span class="n">anything</span> <span class="n">here</span><span class="p">:</span> <span class="s2">&quot;, \, &quot;</span><span class="c1">#, and &gt;# are</span>
<span class="n">no</span> <span class="n">problem</span><span class="o">.</span> <span class="n">The</span> <span class="n">only</span> <span class="n">thing</span> <span class="n">that</span> <span class="n">will</span> <span class="n">terminate</span>
<span class="n">the</span> <span class="n">reading</span> <span class="n">of</span> <span class="n">this</span> <span class="n">string</span> <span class="ow">is</span><span class="o">...</span><span class="n">END</span>

<span class="s2">&quot;I can put anything here: </span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\\</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">#, and &gt;# are</span>
<span class="n">no</span> <span class="n">problem</span><span class="o">.</span> <span class="n">The</span> <span class="n">only</span> <span class="n">thing</span> <span class="n">that</span> <span class="n">will</span> <span class="n">terminate</span>
<span class="n">the</span> <span class="n">reading</span> <span class="n">of</span> <span class="n">this</span> <span class="n">string</span> <span class="ow">is</span><span class="o">...</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="4.4-cl-ppcre.html" class="btn btn-neutral float-right" title="4.4 CL-PPCRE" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="4.2-backquote.html" class="btn btn-neutral float-left" title="4.2 反引用" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021-2022, Yuqi Liu, Xuting Yang.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>